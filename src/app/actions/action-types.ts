/**
 * Shared types for Server Actions
 * 
 * IMPORTANT: These types are extracted from 'use server' files because
 * Next.js App Router requires that files with 'use server' directive
 * can ONLY export async functions.
 */

// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// UPLOAD IMAGES
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
export interface PropertyImageData {
    id: string;
    url: string;
    category: string;  // DB column name is 'category'
    orden: number;
}

// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// LOCATION
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
export interface UpdateLocationResult {
    success: boolean;
    error?: string;
}

// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// FEATURES
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
export interface SaveFeaturesResult {
    success: boolean;
    error?: string;
}

// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// POI ENRICHMENT
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
export interface POIEntry {
    nombre: string;
    tipo: string;
    distancia_m: number;
    lat: number;
    lng: number;
}

export interface EnrichPOIsResult {
    success: boolean;
    count?: number;
    error?: string;
}

// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// DESCRIPTION
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
export interface UpdateDescriptionResult {
    success: boolean;
    error?: string;
}

// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// LISTING DETAILS
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
export interface UpdateListingResult {
    success: boolean;
    error?: string;
}

// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// PAYMENT VERIFICATION
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
export interface VerifyPaymentResult {
    success: boolean;
    status?: string;
    propertyId?: string;
    error?: string;
}

// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// AI GENERATION - DESCRIPTION
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
export interface PropertyFeatures {
    habitaciones: number;
    banos: number;
    area: number;
    estrato: number;
    servicios: string[];
    amenities: string[];
    tipo_inmueble: string;
    barrio: string;
}

export interface GeneratedDescription {
    titulo: string;
    descripcion: string;
}

// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// AI ANALYSIS - GEMINI
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
export interface PropertyAnalysisResult {
    habitaciones: number;
    banos: number;
    area_m2: number;
    estrato: number;
    amenities: string[];
    servicios: string[];
    description_summary: string;
    missing_info: string[];
}

// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// AD COPY GENERATION
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
export interface GeneratedCopy {
    title: string;
    description: string;
    keywords: string[];
}

export interface GenerateCopyResult {
    success: boolean;
    data?: GeneratedCopy;
    error?: string;
}

// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// UTILITY FUNCTIONS (also cannot be in 'use server' files)
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

/**
 * Aggressively cleans JSON from AI responses by removing markdown and extracting pure JSON
 */
export function cleanJson(text: string): string {
    console.log('๐งน Cleaning JSON from raw text...');

    // Step 1: Remove markdown code blocks
    let cleaned = text
        .replace(/```json\s*/gi, '')
        .replace(/```\s*/gi, '')
        .trim();

    // Step 2: Find first { and last } to extract only the JSON object
    const firstBrace = cleaned.indexOf('{');
    const lastBrace = cleaned.lastIndexOf('}');

    if (firstBrace === -1 || lastBrace === -1) {
        console.error('โ No JSON braces found in response');
        return '{}';
    }

    cleaned = cleaned.substring(firstBrace, lastBrace + 1);
    console.log('๐งน Cleaned JSON:', cleaned.substring(0, 200) + '...');

    return cleaned;
}
